name: Déploiements

on:
  release:
    types: [created]

concurrency: production

permissions:
  contents: write
  pull-requests: write
  repository-projects: write

jobs:
  deploy-back:
    runs-on: ubuntu-latest
    steps:
      - name: Déclencher le déploiement Render
        env:
          deploy_url: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          curl -X POST "$deploy_url"
  deploy-front:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Clean and install dependencies
        run: |
          cd front
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps
          cd node_modules/rollup
          npm install @rollup/rollup-linux-x64-gnu --save-optional --force || true
          cd ../..
          cd node_modules/@swc/core
          npm install @swc/core-linux-x64-gnu --save-optional --force || true
          cd ../../..

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: cd front && npm run build

      - name: Deploy Frontend to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOSTNAME }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          local-dir: "front/dist/"
          server-dir: "observatoire-billets-train/"
