name: Vérification des exports et dépendances non utilisés

on:
  push:

jobs:
  check-unused:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Install front dependencies
        working-directory: ./front
        run: npm ci

      - name: Install back dependencies
        working-directory: ./back
        run: npm ci

      - name: Check ts-prune front
        working-directory: ./front
        continue-on-error: true
        run: |
          OUTPUT=$(npx ts-prune --project tsconfig.app.json 2>/dev/null | grep -v "(used in module)" | grep -v " - default$" | grep -v "src/components/ui" || true)
          if [ -n "$OUTPUT" ]; then
            echo "Exports non utilisés détectés :"
            echo "$OUTPUT"
            exit 1
          fi

      - name: Check ts-prune back
        working-directory: ./back
        continue-on-error: true
        run: |
          OUTPUT=$(npx ts-prune --project tsconfig.json 2>/dev/null | grep -v "(used in module)" | grep -v " - default$" || true)
          if [ -n "$OUTPUT" ]; then
            echo "Exports non utilisés détectés :"
            echo "$OUTPUT"
            exit 1
          fi

      - name: Check depcheck front
        working-directory: ./front
        continue-on-error: true
        run: |
          npx depcheck --ignores="@types/*,eslint*,@eslint/*,typescript-eslint,autoprefixer,postcss,tailwindcss,tailwindcss-animate,@tailwindcss/*,@vitejs/*,vite,globals"

      - name: Check depcheck back
        working-directory: ./back
        continue-on-error: true
        run: |
          npx depcheck --ignores="@types/*,nodemon,ts-node,typescript"
